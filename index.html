<!-- 这是可以通用的html部分 -->

<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
	<meta name="description" content="展示一些样例,写一些书籍,干点啥好呢,gy的网站">
	<meta name="keywords" content="three.js,demos,canvas,webgl,tricks,前端,guoyang,gy134340,web">
	<link rel="icon" href="img/icon/favicon.png">
	<link rel="stylesheet" href="css/reset.css">
	<style>
		.container{
			width: 100%;
			height: 100%;
			position: relative;
		}
		.message{
			position: absolute;
			z-index: 999;
			color:#fff;
			font-size: 16px;
			-webkit-transform:translate(-50%, -50%);
			transform: translate(-50%, -50%);

		}
		.title{
			color:#fff;
			position: absolute;
			font-size: 20px;
			top:10px;
			-webkit-transform:translateX(-50%);
			transform: translateX(-50%);
			left:50%;
			width: auto;
			margin: 0 auto;
		}
		#paint{
			position: absolute;
			width:600px;
			height:400px;
			left:50%;
			top:55%;
			background:rgba(0,0,0,0.5); 
			-webkit-transform:translate(-50%,-50%);
			transform:translate(-50%,-50%);
			border: 1px solid #fff;
		}
		.event{
			position: absolute;
			top:88%;
			left:50%;
			-webkit-transform:translate(-50%,-50%);
			transform:translate(-50%,-50%);
			width:180px;
			height: 30px;
			display: -webkit-box;
			display: box;
		}
		.event .sub{
			width: auto;
			border: 1px solid #fff;
			margin:0 8px;
			cursor: pointer;
			color:#fff;
			text-align: center;
			-webkit-box-flex:1;
			box-flex:1;
		}
		.event .sub:hover{
			border: 1px solid #ccc;
			color:#ccc;
		}
		.sub p{
			line-height: 30px;
			font-size: 18px;
			text-align: center;
		}
		button.drawing-board-control-navigation-reset{
			display: none;
		}

	</style>
</head>
<body>
<div class="container">
	<p class="title">Please paint something in canavs</p>
	<div id="paint">
		<div class="event">
			<div class="reset sub drawing-board-control-navigation-reset"><p>Reset</p></div>
			<div class="go sub"><p> G o </p></div>
		</div>
	</div>
	<!-- <div class="event">
		<div class="reset sub drawing-board-control-navigation-reset"><p>Reset</p></div>
		<div class="go sub"><p> G o </p></div>
	</div> -->
</div>
</body>
<script src="js/three.min.js"></script>
<script src="js/renderers/Projector.js"></script>
<script src="js/libs/stats.min.js"></script>
<script src="js/controls/TrackballControls.js"></script>
<script src="js/libs/tween.min.js"></script>
<script src="js/libs/jquery-1.11.1.min.js"></script>
<script src="js/libs/drawingboard.min.js"></script>

<script type="text/javascript">


var container,stats;	
var canvas;
var camera,scene,renderer,controls;
var raycaster;			// 点击发出的一条射线
var mouse = new THREE.Vector2();	// 点向量
mouse.x = 0;
mouse.y = 0;

var cubes = [];

var winWidth = window.innerWidth;
var winHeight = window.innerHeight;



function init () {
	container = document.querySelectorAll('.container')[0];

	scene = new THREE.Scene();

	// 相机
	camera = new THREE.PerspectiveCamera(75, winWidth / winHeight, 1, 1000);
	camera.position.set(0, 0, 1000);
	camera.lookAt(0, 0, 0);

	// 光
	// var light = new THREE.PointLight(0xffffff, 1, 0); 
	// light.position.set(0,0,200)
	// scene.add(light);
	var light = new THREE.AmbientLight( 0xffffff ); // soft white light
	scene.add( light );

	// 添加小块
	setCubes();
	addBoard();
	
	// renderer 
	renderer = new THREE.WebGLRenderer( {antialias: true} );
	renderer.setClearColor(0x000000,1);
	renderer.setPixelRatio(window.devivePixelRatio);
	renderer.setSize(window.innerWidth, window.innerHeight);
	container.append(renderer.domElement);

	// 统计
	stats = new Stats();
	container.appendChild(stats.dom);

	// 控制器
	controls = new THREE.TrackballControls( camera, renderer.domElement );
	controls.speed = 5;
	// controls.noPan = false;
	// controls.noZoom = false;
	controls.rotateSpeed = 1.0;
	controls.zoomSpeed = 1.2;
	controls.panSpeed = 0.8;

	controls.staticMoving = true;
	controls.dynamicDampingFactor = 0.3;

	window.addEventListener( 'resize', onWindowResize, false );
}

function addBoard(){
	var simpleBoard = new DrawingBoard.Board('paint', {
		background:'rgba(0,0,0,0.1)',
		color:'#ccc',
		size:2,
		controls: [
			{ Navigation: { back: false, forward: false } },
		],
		webStorage: false
	});

	$("body").on('click','.event .reset', function(e){
		e.preventDefault();
		$("button.drawing-board-control-navigation-reset").trigger('click');
	});

	$("body").on('click','.event .go', function(e){
		e.preventDefault();
		var dt = getTextData();
		cubesLocation(dt);
	});
}

var updateCube = function(){
	this.domElement.rotation.x += Math.random() * 0.01;
	this.domElement.rotation.y += Math.random() * 0.01;
	this.domElement.rotation.z += Math.random() * 0.01;
}

function setCubes(){
	var geometry = new THREE.OctahedronGeometry(15, 0);
	var material = new THREE.MeshPhongMaterial( {color: 0x156289, wireframe: true} );
	for(var i = 0; i <  10000; i++ ){
		var cube = new THREE.Mesh( geometry, material );
		var x = Math.random() * 10000 - 5000;
		var y = Math.random() * 10000 - 5000;
		var z = Math.random() * 20 - 10;
		cube.position.set(x, y, z);
		var subRotate = new TWEEN.Tween({domElement:cube}).to({}, 12000).onUpdate(updateCube);
						
		subRotate.chain(subRotate);
		subRotate.start();
		cubes.push(cube);
		scene.add(cube);
	}
}

// processed text data
function getTextData(){
	var canvas = document.querySelectorAll('.drawing-board-canvas')[0];
	var ctx = canvas.getContext("2d");
	var imgData = ctx.getImageData(0,0,canvas.width,canvas.height);
	var data = imgData.data;
	var dt = {
		data:[],
		num:0,
		width:imgData.width,
		height:imgData.height
	};
	var num = 0;
	for(var i = 0; i < data.length; i+=4){
		var tmp = 0;
		if(data[i] || data[i+1] || data[i+2] ){			// red pixel:255
			tmp = 1;
			num++;
		}

		dt.data.push(tmp);
	}
	dt.num = num;
	// console.log('dt', dt);
	return dt;
}

function cubesLocation(dt){
	var cWidth = dt.width;
	var cHeight = dt.height;
	var data = dt.data;
	var xSpace = Math.round(1000 / cWidth);
	var ySpace = Math.round(1000 / cHeight)
	var cubeIndex = 0;

	for(var j = 0; j < cHeight; j++){
		for(var i = 0; i < cWidth; i++){
			var index = j * cWidth + i;
			if(data[index] === 1){
				var cube = cubes[cubeIndex];
				if(cube){
					cube.scale.x = cube.scale.y = cube.scale.z = 0.1;
					var poiX = i * xSpace - 500;
					var poiY = 1350 - j * ySpace -500;
					var inX = Math.random() * 600 - 300;
					var inY = Math.random() * 300 - 300;

					var cubeSpread = new TWEEN.Tween(cube.position)
								.to({x:poiX, y:poiY, z:50}, Math.random() * 500 + 3000 )
								.easing( TWEEN.Easing.Exponential.InOut );
					var cubeIn  = new TWEEN.Tween(cube.position)
								.to({x:inX, y:inY, z:150}, Math.random() * 500 + 2000 )
								.easing( TWEEN.Easing.Exponential.InOut );
					cubeIn.chain(cubeSpread);
					cubeIn.start();
					cubeIndex++;
				}			
			}
		}
	}		
};

// 方块不够组成文字，添加额外的方块
function addExtraCubes(num, extras){
	var textCubes = [];
	var amount = num + 2000;		// add extra amout, num值正负都有可能

	var geometry = new THREE.BoxGeometry(100, 100, 100);
	for (var i = 0; i < amount; i++) {
		var textures = [];
		for(var j = 0; j < 6; j++){
			var rand = Math.ceil(Math.random() * 96);
			textures[j] = cubeTextures[rand];
		}				
		var materials = [
		    new THREE.MeshPhongMaterial( { map: textures[0] } ), // right
		    new THREE.MeshPhongMaterial( { map: textures[1] } ), // left
		    new THREE.MeshPhongMaterial( { map: textures[2] } ), // top
		    new THREE.MeshPhongMaterial( { map: textures[3] } ), // bottom
		    new THREE.MeshPhongMaterial( { map: textures[4] } ), // back
		    new THREE.MeshPhongMaterial( { map: textures[5] } )  // front
		];
		
		var cubeMaterial = new THREE.MultiMaterial( materials );
		var object = new THREE.Mesh( geometry, cubeMaterial );
		object.position.x = Math.random() * 12000 - 6000;
		object.position.y = Math.random() * 5400 - 2700;
		object.position.z = Math.random() * 1000 + 1200;
		extras.push(object);
		scene.add(object);
	}
	textCubes = textCubes.concat(cubes,extras);
	return textCubes;
}

// 不组成文字的方块定位
function extrasLocation(textCubes, cubeIndex){
	for(var k = cubeIndex; k < textCubes.length; k++){
		var subCube = textCubes[k];
		if(!subCube.userData.isInteracted){
			subCube.scale.x = subCube.scale.y = subCube.scale.z = 0.08;
			var subX = Math.random() * 3000;
			var subY = Math.random() * 1350;
			var inX = Math.random() * 600 + 1200;
			var inY = Math.random() * 300 + 400;

			var crowdSpread = new TWEEN.Tween(subCube.position)
								.to({x:subX, y:subY, z:50}, Math.random() * 500 + 3000 )
								.easing( TWEEN.Easing.Exponential.InOut );
			var crowdIn  = new TWEEN.Tween(subCube.position)
							.to({x:inX, y:inY, z:150}, Math.random() * 500 + 2000 )
							.easing( TWEEN.Easing.Exponential.InOut );
			crowdIn.chain(crowdSpread);
			crowdIn.start();
				
			var subRotate = new TWEEN.Tween({domElement:subCube})
					.to({}, 12000 )
					.onUpdate(updateTextCube)
					.easing( TWEEN.Easing.Exponential.InOut )
					.start();
		}	
	}
}

// 组成文字的方块定位
function textCubesLocation(dt){
	var cWidth = dt.width;
	var cHeight = dt.height;
	var data = dt.data;
	var xSpace = Math.round(3000 / cWidth);
	var ySpace = Math.round(1350 / cHeight)
	var cubeIndex = 0;
	var extraNum = dt.num - cubes.length;
	var extras = [];
	var textCubes = addExtraCubes(extraNum, extras);		// cubes and extras

	for(var j = 0; j < cHeight; j++){
		for(var i = 0; i < cWidth; i++){
			var index = j * cWidth + i;
			if(data[index] === 1){
				var cube = textCubes[cubeIndex];
				if(!cube.userData.isInteracted){
					cube.scale.x = cube.scale.y = cube.scale.z = 0.1;
					var poiX = i * xSpace;
					var poiY = 1350 - j * ySpace;
					var inX = Math.random() * 600 + 1200;
					var inY = Math.random() * 300 + 400;

					var cubeSpread = new TWEEN.Tween(cube.position)
								.to({x:poiX, y:poiY, z:50}, Math.random() * 500 + 3000 )
								.easing( TWEEN.Easing.Exponential.InOut );
					var cubeIn  = new TWEEN.Tween(cube.position)
								.to({x:inX, y:inY, z:150}, Math.random() * 500 + 2000 )
								.easing( TWEEN.Easing.Exponential.InOut );
					cubeIn.chain(cubeSpread);
					cubeIn.start();

					var textRotate = new TWEEN.Tween({domElement:cube})
					.to({}, 12000 )
					.onUpdate(updateTextCube)
					.easing( TWEEN.Easing.Exponential.InOut )
					.start();
				}
				cubeIndex++;		
			}
		}
	}
	extrasLocation(textCubes, cubeIndex);
	return extras;			// note: extras should to be deleted
}

function restoreTextFormation(extras){
	for(var i = 0; i < extras.length; i++){
		scene.remove(extras[i]);
	}

	for(var j = 0; j < cubes.length; j++){
		var tmp = cubes[j];

		if(tmp.userData.isInteracted === false){
			tmp.scale.x = tmp.scale.y = tmp.scale.z = 1;
			tmp.rotation.x = tmp.rotation.y = tmp.rotation.z = 0;
		}
	}
}

function textFormation(time){
	var imgData = getLogoData()
	var dt = getTextData(imgData);
	var extras = textCubesLocation(dt);

	return new Promise(function(resolve,reject){
		setTimeout(function(){
			restoreTextFormation(extras);
			resolve();
		},time);
	});
}

var theta = 0;
var radius = 400;
function render(){

	// theta += 0.1;  // 自动渲染
	// camera.position.x = radius * Math.sin( THREE.Math.degToRad( theta ) );
	// camera.position.z = radius * Math.cos( THREE.Math.degToRad( theta ) );
	camera.lookAt(scene.position);
	camera.updateProjectionMatrix();

	renderer.render(scene, camera);
}

function animate () {
	requestAnimationFrame(animate);

	render();
	TWEEN.update();
	stats.update();
	controls.update();
}

init();
animate();

function onWindowResize(){

	renderer.setPixelRatio( window.devicePixelRatio );
	camera.aspect = window.innerWidth / window.innerHeight;
	camera.updateProjectionMatrix();
	renderer.setSize( window.innerWidth, window.innerHeight );
}


	
function fastAbs(value){
	return (value ^ (value >> 31)) - (value >> 31);
}

function threshold(value){
	return (value > 0x15) ? 0xFF : 0;
}

</script>
</html>

